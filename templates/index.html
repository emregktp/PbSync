<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PbSync - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --pbs-bg-body: #f5f5f5;
            --pbs-bg-panel: #ffffff;
            --pbs-bg-header: #333333;
            --pbs-text-main: #333333;
            --pbs-text-muted: #666666;
            --pbs-border: #cccccc;
            --pbs-input-bg: #ffffff;
            --pbs-input-text: #333333;
            --pbs-orange: #E57000;
            --pbs-blue: #3892d6;
            --pbs-green: #21ba45;
            --pbs-red: #ff4d4d;
            --pbs-header-text: #ffffff;
        }

        [data-theme="dark"] {
            --pbs-bg-body: #121212;
            --pbs-bg-panel: #212121;
            --pbs-bg-header: #282929;
            --pbs-text-main: #e0e0e0;
            --pbs-text-muted: #abb2bf;
            --pbs-border: #383838;
            --pbs-input-bg: #121212;
            --pbs-input-text: #e0e0e0;
        }

        body {
            background-color: var(--pbs-bg-body);
            color: var(--pbs-text-main);
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        /* --- HEADER --- */
        .pbs-header {
            background-color: var(--pbs-bg-header);
            border-bottom: 2px solid var(--pbs-orange);
            padding: 0 20px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--pbs-header-text);
        }
        .logo-text { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
        .logo-text span { color: var(--pbs-orange); }

        .header-actions { display: flex; align-items: center; gap: 15px; }

        /* STATUS BADGES */
        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ccc;
            cursor: help;
            transition: all 0.3s;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #666; }
        
        .status-online { color: #fff; border-color: var(--pbs-green); background: rgba(33, 186, 69, 0.1); }
        .status-online .status-dot { background-color: var(--pbs-green); box-shadow: 0 0 5px var(--pbs-green); }
        
        .status-offline { color: #ffcccc; border-color: var(--pbs-red); background: rgba(255, 77, 77, 0.1); }
        .status-offline .status-dot { background-color: var(--pbs-red); box-shadow: 0 0 5px var(--pbs-red); }

        /* Error Alert */
        #globalError {
            display: none;
            background-color: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--pbs-red);
            color: var(--pbs-red);
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            width: 100%;
        }

        /* Theme Switcher */
        .theme-switch {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .theme-switch option { background-color: #333; color: white; }

        .btn-config {
            background-color: transparent; color: #ccc; border: 1px solid #666;
            padding: 5px 12px; border-radius: 2px; font-size: 12px; text-decoration: none;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-config:hover { color: #fff; border-color: #fff; }

        /* --- LAYOUT --- */
        .status-bar {
            background-color: var(--pbs-bg-panel); border-bottom: 1px solid var(--pbs-border);
            padding: 10px 20px; display: flex; align-items: center; font-size: 13px; color: var(--pbs-text-muted);
        }
        .main-container { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; }
        .pbs-panel {
            background-color: var(--pbs-bg-panel); border: 1px solid var(--pbs-border);
            width: 100%; max-width: 900px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 4px;
        }
        .pbs-panel-header {
            background-color: var(--pbs-bg-body); padding: 12px 20px; border-bottom: 1px solid var(--pbs-border);
            font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 15px; color: var(--pbs-text-main);
        }
        .pbs-panel-body { padding: 25px; }

        /* --- FORMS --- */
        .form-label { color: var(--pbs-text-main); font-weight: 600; font-size: 13px; margin-bottom: 6px; display: block; }
        .form-control, .form-select {
            background-color: var(--pbs-input-bg); border: 1px solid var(--pbs-border);
            color: var(--pbs-input-text); border-radius: 3px; font-size: 14px; padding: 10px;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--pbs-input-bg); border-color: var(--pbs-blue);
            color: var(--pbs-input-text); box-shadow: 0 0 0 2px rgba(56, 146, 214, 0.2);
        }
        
        .btn-pbs {
            background-color: var(--pbs-blue); color: white; border: none;
            border-radius: 3px; font-weight: 600; padding: 10px 20px;
            font-size: 14px; display: inline-flex; align-items: center; gap: 8px;
            transition: 0.2s; cursor: pointer;
        }
        .btn-pbs:hover { background-color: #2c7bb6; }
        .btn-pbs:disabled { background-color: #777; cursor: not-allowed; }

        .log-window {
            background-color: #1e1e1e; border: 1px solid var(--pbs-border);
            font-family: 'Roboto Mono', monospace; font-size: 12px; padding: 15px;
            color: #d4d4d4; height: 200px; overflow-y: auto; margin-top: 20px;
            border-radius: 4px; display: none;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-success { color: #4caf50; font-weight: bold; }
        .log-error { color: #f44336; font-weight: bold; }
        .log-info { color: #64b5f6; }

    </style>
</head>
<body>

    <div class="pbs-header">
        <div class="logo-text"><i class="bi bi-hdd-network me-2"></i><span>Pb</span>Sync</div>
        
        <div class="header-actions">
            <div id="pbsStatus" class="status-badge" title="Checking connection...">
                <div class="status-dot"></div> PBS
            </div>
            <div id="rcloneStatus" class="status-badge" title="Checking connection...">
                <div class="status-dot"></div> Cloud
            </div>

            <select class="theme-switch ms-2" id="themeSelector" onchange="setTheme(this.value)">
                <option value="auto">üåó Auto</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåë Dark</option>
            </select>

            <a href="/setup" class="btn-config">
                <i class="bi bi-gear-fill"></i> 
                <span>Config</span>
            </a>
        </div>
    </div>

    <div class="status-bar">
        <span>Datacenter</span>
        <i class="bi bi-chevron-right mx-2 opacity-50"></i>
        <span>PbSync Node</span>
        <i class="bi bi-chevron-right mx-2 opacity-50"></i>
        <span>Stream Task</span>
    </div>

    <div class="main-container">
        
        <div id="globalError">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> 
            <span id="globalErrorText">System Error</span>
        </div>

        <div class="pbs-panel">
            <div class="pbs-panel-header">
                <i class="bi bi-cloud-upload-fill"></i> New Backup Stream Job
            </div>
            
            <div class="pbs-panel-body">
                <form id="backupForm" onsubmit="return false;">
                    
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <h6 class="text-uppercase small fw-bold opacity-75 border-bottom pb-2" style="border-color: var(--pbs-border) !important;">1. Source Selection</h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Virtual Machine / Container</label>
                            <div class="input-group">
                                <select id="vmSelect" class="form-select" onchange="loadSnapshots(this.value)">
                                    <option value="" selected disabled>Select a VM...</option>
                                    <option value="manual">-- Enter Manually --</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="scanVMs()" title="Refresh VM List">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div id="manualVmArea" class="mt-2 d-none">
                                <input type="text" id="manualVmInput" class="form-control" placeholder="Enter ID (e.g. 100 or vm/100)">
                                <button type="button" onclick="loadSnapshots(document.getElementById('manualVmInput').value)" class="btn btn-sm btn-secondary mt-2 w-100">Scan This ID</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Available Snapshot</label>
                            <select id="snapshotSelect" class="form-select" disabled>
                                <option selected disabled>Waiting for VM selection...</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <h6 class="text-uppercase small fw-bold opacity-75 border-bottom pb-2" style="border-color: var(--pbs-border) !important;">2. Target Configuration</h6>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Target Remote (Rclone)</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: var(--pbs-bg-body); border-color: var(--pbs-border); color: var(--pbs-text-main);"><i class="bi bi-cloud-check-fill"></i></span>
                                <select id="remoteSelect" class="form-select">
                                    {% if remotes and not "ERROR" in remotes[0] %}
                                        {% for remote in remotes %}
                                        <option value="{{ remote }}">{{ remote }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled selected>{{ remotes[0] or "No rclone remotes found." }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end pt-3 border-top" style="border-color: var(--pbs-border) !important;">
                        <button type="button" id="startBackupBtn" onclick="startBackup()" class="btn-pbs">
                            <i class="bi bi-play-circle-fill"></i> Start Stream Task
                        </button>
                    </div>

                </form>

                <div id="logWindow" class="log-window">
                    <div class="log-line text-muted"># System ready. Waiting for job...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Logic ---
        function setTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('pbs_theme', theme);
            if (theme === 'auto') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.setAttribute('data-theme', 'light');
                }
            }
        }
        const savedTheme = localStorage.getItem('pbs_theme') || 'auto';
        document.getElementById('themeSelector').value = savedTheme;
        setTheme(savedTheme);

        // --- App Logic ---
        const vmSelect = document.getElementById("vmSelect");
        const manualVmArea = document.getElementById("manualVmArea");
        const snapshotSelect = document.getElementById("snapshotSelect");
        const logWindow = document.getElementById("logWindow");
        const globalError = document.getElementById("globalError");
        const globalErrorText = document.getElementById("globalErrorText");

        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            scanVMs();
        });

        async function checkStatus() {
            try {
                const res = await fetch("/check-status");
                const status = await res.json();
                
                updateBadge('pbsStatus', status.pbs);
                updateBadge('rcloneStatus', status.rclone);

                // Show global error if connections fail
                if (!status.pbs.status || !status.rclone.status) {
                    let msg = "";
                    if (!status.pbs.status) msg += `[PBS] ${status.pbs.msg} `;
                    if (!status.rclone.status) msg += `[Cloud] ${status.rclone.msg}`;
                    showGlobalError(msg);
                } else {
                    globalError.style.display = 'none';
                }

            } catch(e) {
                console.error("Status check failed", e);
                showGlobalError("Frontend could not reach Backend API.");
            }
        }

        function updateBadge(id, statusObj) {
            const badge = document.getElementById(id);
            badge.className = 'status-badge ' + (statusObj.status ? 'status-online' : 'status-offline');
            badge.title = statusObj.msg; // Tooltip shows the error
        }

        function showGlobalError(msg) {
            globalError.style.display = 'block';
            globalErrorText.innerText = msg;
        }

        function log(msg, type = 'info') {
            logWindow.style.display = 'block';
            const line = document.createElement('div');
            line.className = 'log-line';
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let colorClass = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : 'log-info');
            line.innerHTML = `<span class="text-muted small">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
            logWindow.appendChild(line);
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        async function scanVMs() {
            vmSelect.innerHTML = '<option disabled selected>Scanning...</option>';
            try {
                const response = await fetch("/scan-vms", {method: "POST"});
                const data = await response.json();
                vmSelect.innerHTML = '<option value="" selected disabled>Select a VM...</option>';
                if (data.status === 'success') {
                    data.vms.forEach(vm => vmSelect.appendChild(new Option(vm, vm)));
                } else {
                    log("VM Scan Failed: " + data.message, "error");
                }
                vmSelect.appendChild(new Option("-- Enter Manually --", "manual"));
            } catch (e) {
                log("Network Error during VM Scan", "error");
                vmSelect.innerHTML = '<option value="manual">Manual Entry Only</option>';
            }
        }

        async function loadSnapshots(val) {
            if (val === 'manual') manualVmArea.classList.remove('d-none');
            else manualVmArea.classList.add('d-none');
            if(!val || val === 'manual') return;

            snapshotSelect.innerHTML = '<option>Loading snapshots...</option>';
            snapshotSelect.disabled = true;

            let formData = new FormData();
            formData.append("vmid", val);

            try {
                const response = await fetch("/scan-snapshots", {method: "POST", body: formData});
                const data = await response.json();
                snapshotSelect.innerHTML = '';
                if (data.status === 'success') {
                    data.snapshots.forEach(snap => snapshotSelect.add(new Option(snap, snap)));
                    snapshotSelect.disabled = false;
                    log(`Loaded ${data.snapshots.length} snapshots for ${val}`, "success");
                } else {
                    snapshotSelect.innerHTML = '<option>No snapshots found</option>';
                    log(`No snapshots found for ${val}`, "info");
                }
            } catch (e) {
                log("Error loading snapshots", "error");
            }
        }

        async function startBackup() {
            const snapshot = snapshotSelect.value;
            const remote = document.getElementById("remoteSelect").value;
            if (!snapshot || snapshotSelect.disabled) {
                log("Please select a snapshot first.", "error");
                return;
            }
            log(`Starting stream: ${snapshot} -> ${remote}`, "info");
            document.getElementById("startBackupBtn").disabled = true;
            let formData = new FormData();
            formData.append("snapshot", snapshot);
            formData.append("remote", remote);
            try {
                const res = await fetch("/start-stream", {method: "POST", body: formData});
                const data = await res.json();
                if(data.status === 'started') {
                    log("SUCCESS: Backup job started.", "success");
                    log("Check server logs for details.", "info");
                } else {
                    log("FAILED: " + data.message, "error");
                }
            } catch (e) { log("Connection Failed.", "error"); }
            setTimeout(() => document.getElementById("startBackupBtn").disabled = false, 3000);
        }
    </script>
</body>
</html>