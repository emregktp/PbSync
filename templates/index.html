<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PbSync - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --pbs-bg-body: #f5f5f5; --pbs-bg-panel: #ffffff; --pbs-bg-header: #333333; --pbs-text-main: #333333; --pbs-text-muted: #666666; --pbs-border: #cccccc; --pbs-input-bg: #ffffff; --pbs-input-text: #333333; --pbs-input-disabled: #e9ecef; --pbs-orange: #E57000; --pbs-blue: #3892d6; --pbs-green: #21ba45; --pbs-red: #ff4d4d; --pbs-header-text: #ffffff; --pbs-hint-bg: #e9ecef; --pbs-hint-text: #555; --pbs-modal-bg: #ffffff; --pbs-dropdown-bg: #ffffff; --pbs-dropdown-hover: #f0f0f0; }
        [data-theme="dark"] { --pbs-bg-body: #121212; --pbs-bg-panel: #212121; --pbs-bg-header: #282929; --pbs-text-main: #e0e0e0; --pbs-text-muted: #bbbbbb; --pbs-border: #383838; --pbs-input-bg: #121212; --pbs-input-text: #e0e0e0; --pbs-input-disabled: #2a2a2a; --pbs-hint-bg: #2a2a2a; --pbs-hint-text: #ddd; --pbs-modal-bg: #212121; --pbs-dropdown-bg: #2c2c2c; --pbs-dropdown-hover: #3a3a3a; }
        body { background-color: var(--pbs-bg-body); color: var(--pbs-text-main); font-family: 'Open Sans', sans-serif; font-size: 14px; margin: 0; height: 100vh; display: flex; flex-direction: column; transition: all 0.3s; }
        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-list { position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--pbs-dropdown-bg); border: 1px solid var(--pbs-border); border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dropdown-item { padding: 8px 12px; cursor: pointer; color: var(--pbs-text-main); display: block; width: 100%; box-sizing: border-box; }
        .dropdown-item:hover { background-color: var(--pbs-dropdown-hover); }
        .form-control::placeholder { color: #999; opacity: 0.8; }
        [data-theme="dark"] .form-control::placeholder { color: #b0b0b0 !important; opacity: 1 !important; }
        .form-text, .text-muted { color: var(--pbs-text-muted) !important; }
        .pbs-header { background-color: var(--pbs-bg-header); border-bottom: 2px solid var(--pbs-orange); padding: 0 20px; height: 55px; display: flex; align-items: center; justify-content: space-between; color: var(--pbs-header-text); }
        .logo-text { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
        .logo-text span { color: var(--pbs-orange); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .status-badge { font-size: 11px; padding: 4px 10px; border-radius: 4px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 6px; color: #ccc; cursor: help; transition: all 0.3s; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #666; }
        .status-online { color: #fff; border-color: var(--pbs-green); background: rgba(33, 186, 69, 0.1); }
        .status-online .status-dot { background-color: var(--pbs-green); box-shadow: 0 0 5px var(--pbs-green); }
        .status-offline { color: #ffcccc; border-color: var(--pbs-red); background: rgba(255, 77, 77, 0.1); }
        .status-offline .status-dot { background-color: var(--pbs-red); box-shadow: 0 0 5px var(--pbs-red); }
        #globalError { display: none; background-color: rgba(255, 77, 77, 0.1); border: 1px solid var(--pbs-red); color: var(--pbs-red); padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 13px; width: 100%; }
        .theme-switch { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .theme-switch option { background-color: #333; color: white; }
        .btn-config { background-color: transparent; color: #ccc; border: 1px solid #666; padding: 5px 12px; border-radius: 2px; font-size: 12px; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-config:hover { color: #fff; border-color: #fff; }
        .status-bar { background-color: var(--pbs-bg-panel); border-bottom: 1px solid var(--pbs-border); padding: 10px 20px; display: flex; align-items: center; font-size: 13px; color: var(--pbs-text-muted); }
        .main-container { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; }
        .pbs-panel { background-color: var(--pbs-bg-panel); border: 1px solid var(--pbs-border); width: 100%; max-width: 900px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 4px; }
        .pbs-panel-header { background-color: var(--pbs-bg-body); padding: 12px 20px; border-bottom: 1px solid var(--pbs-border); font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 15px; color: var(--pbs-text-main); }
        .pbs-panel-body { padding: 25px; }
        .form-label { color: var(--pbs-text-main); font-weight: 600; font-size: 13px; margin-bottom: 6px; display: block; }
        .form-control, .form-select { background-color: var(--pbs-input-bg); border: 1px solid var(--pbs-border); color: var(--pbs-input-text); border-radius: 3px; font-size: 14px; padding: 10px; }
        .form-control:disabled, .form-select:disabled { background-color: var(--pbs-input-disabled) !important; color: var(--pbs-text-muted); border-color: var(--pbs-border); opacity: 1; }
        .form-control:focus, .form-select:focus { background-color: var(--pbs-input-bg); border-color: var(--pbs-blue); color: var(--pbs-input-text); box-shadow: 0 0 0 2px rgba(56, 146, 214, 0.2); }
        .form-hint-box { font-size: 0.85em; color: var(--pbs-hint-text); background-color: var(--pbs-hint-bg); padding: 8px 12px; border-radius: 4px; margin-top: 6px; border-left: 3px solid var(--pbs-blue); line-height: 1.4; }
        .form-hint-box code { color: var(--pbs-blue); font-family: 'Roboto Mono', monospace; background: rgba(56, 146, 214, 0.1); padding: 2px 4px; border-radius: 3px; }
        .btn-pbs { background-color: var(--pbs-blue); color: white; border: none; border-radius: 3px; font-weight: 600; padding: 10px 20px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; cursor: pointer; }
        .btn-pbs:hover { background-color: #2c7bb6; }
        .btn-pbs:disabled { background-color: #777; cursor: not-allowed; }
        .btn-refresh { background-color: transparent; border: 1px solid var(--pbs-border); color: var(--pbs-text-main); padding: 9px 12px; border-radius: 3px; cursor: pointer; }
        .btn-refresh:hover { background-color: var(--pbs-hover); }
        .log-window { background-color: #1a1a1a; border: 1px solid var(--pbs-border); font-family: 'Roboto Mono', monospace; font-size: 12px; padding: 15px; color: #eeeeee; height: 200px; overflow-y: auto; margin-top: 20px; border-radius: 4px; display: block; white-space: pre-wrap; }
        [data-theme="dark"] .log-window .text-muted { color: #bbbbbb !important; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-success { color: #2ecc71; font-weight: bold; }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-info { color: #64b5f6; }
        .modal-content { background-color: var(--pbs-modal-bg); border: 1px solid var(--pbs-border); color: var(--pbs-text-main); }
        .modal-header, .modal-footer { border-color: var(--pbs-border); }
        .list-group-item { background-color: transparent; color: var(--pbs-text-main); border-color: var(--pbs-border); }
        .list-group-item:hover { background-color: var(--pbs-input-disabled); }
    </style>
</head>
<body>
    <div class="pbs-header">
        <div class="logo-text"><i class="bi bi-hdd-network me-2"></i><span>Pb</span>Sync</div>
        <div class="header-actions">
            <div id="pbsStatus" class="status-badge" title="Checking connection..."><div class="status-dot"></div> PBS</div>
            <div id="rcloneStatus" class="status-badge" title="Checking connection..."><div class="status-dot"></div> Cloud</div>
            <select class="theme-switch ms-2" id="themeSelector" onchange="setTheme(this.value)">
                <option value="auto">üåó Auto</option>
                <option value="light">‚òÄÔ∏è Light</option>
                <option value="dark">üåë Dark</option>
            </select>
            <a href="/setup" class="btn-config"><i class="bi bi-gear-fill"></i><span>Config</span></a>
        </div>
    </div>

    <div class="status-bar">
        <span>Datacenter</span><i class="bi bi-chevron-right mx-2 opacity-50"></i><span>PbSync Node</span><i class="bi bi-chevron-right mx-2 opacity-50"></i><span>Stream Task</span>
    </div>

    <div class="main-container">
        <div id="globalError"><i class="bi bi-exclamation-triangle-fill me-2"></i><span id="globalErrorText">System Error</span></div>
        <div class="pbs-panel">
            <div class="pbs-panel-header"><i class="bi bi-cloud-upload-fill"></i> New Backup Stream Job</div>
            <div class="pbs-panel-body">
                <form id="backupForm" onsubmit="return false;">
                    <div class="row g-4 mb-4">
                        <div class="col-12"><h6 class="text-uppercase small fw-bold opacity-75 border-bottom pb-2" style="border-color: var(--pbs-border) !important;">1. Source Selection</h6></div>
                        <div class="col-md-6">
                            <label class="form-label">Virtual Machine / Container</label>
                            <div class="input-group custom-dropdown">
                                <input type="text" class="form-control" id="vmInput" placeholder="Select or Type VM ID..." autocomplete="off">
                                <button class="btn-refresh" type="button" onclick="scanVMs()" title="Refresh VM List"><i class="bi bi-arrow-clockwise"></i></button>
                                <div id="vmList" class="dropdown-list"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Available Snapshot</label>
                            <select id="snapshotSelect" class="form-select" disabled><option selected disabled>Waiting for VM selection...</option></select>
                        </div>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-12"><h6 class="text-uppercase small fw-bold opacity-75 border-bottom pb-2" style="border-color: var(--pbs-border) !important;">2. Target Configuration</h6></div>
                        <div class="col-md-6">
                            <label class="form-label">Target Remote (Rclone)</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: var(--pbs-bg-body); border-color: var(--pbs-border); color: var(--pbs-text-main);"><i class="bi bi-cloud-check-fill"></i></span>
                                <select id="remoteSelect" class="form-select">
                                    {% if remotes and not "ERROR" in remotes[0] %}
                                        {% for remote in remotes %}
                                        <option value="{{ remote }}">{{ remote }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled selected>{{ remotes[0] or "No rclone remotes found." }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Target Folder (Optional)</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: var(--pbs-bg-body); border-color: var(--pbs-border); color: var(--pbs-text-main);"><i class="bi bi-folder-plus"></i></span>
                                <input type="text" id="targetFolder" class="form-control" placeholder="e.g. Backups/LinuxVMs">
                            </div>
                            <div class="form-hint-box">Leave empty to upload to <b>root</b>.</div>
                        </div>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-12"><h6 class="text-uppercase small fw-bold opacity-75 border-bottom pb-2" style="border-color: var(--pbs-border) !important;">3. Advanced Options</h6></div>
                        <div class="col-12">
                            <label class="form-label">Specific Paths to Backup</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: var(--pbs-bg-body); border-color: var(--pbs-border); color: var(--pbs-text-main);"><i class="bi bi-list-check"></i></span>
                                <input type="text" id="sourcePaths" class="form-control" placeholder="e.g. home, etc/nginx, var/www">
                                <button class="btn btn-outline-secondary" type="button" onclick="openExplorer()"><i class="bi bi-folder2-open me-1"></i> Browse Files</button>
                            </div>
                            <div class="form-hint-box">Leave empty to backup the <b>entire disk</b>.<br>Use <b>Browse Files</b> to pick folders from the snapshot (Mounts snapshot temporarily).</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end pt-3 border-top" style="border-color: var(--pbs-border) !important;">
                        <button type="button" id="startBackupBtn" onclick="startBackup()" class="btn-pbs"><i class="bi bi-play-circle-fill"></i> Start Stream Task</button>
                    </div>
                </form>
                <div id="logWindow" class="log-window"><div class="log-line text-muted"># System ready. Waiting for job...</div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="explorerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><i class="bi bi-hdd-stack me-2"></i>Snapshot Explorer</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body p-0">
                    <div class="d-flex align-items-center p-2 border-bottom" style="background-color: var(--pbs-input-disabled);">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="backToPartsBtn" onclick="openExplorer()" style="display:none;"><i class="bi bi-hdd me-1"></i>Disks</button>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="upDirBtn" onclick="goUpDir()" style="display:none;"><i class="bi bi-arrow-90deg-up me-1"></i>Up</button>
                        <div class="d-flex align-items-center ms-1 text-muted overflow-hidden">
                            <i class="bi bi-folder2-open me-2"></i>
                            <span id="currentPathLabel" class="small text-truncate">...</span>
                        </div>
                    </div>
                    <div id="explorerList" class="list-group list-group-flush"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function setTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('pbs_theme', theme);
            if (theme === 'auto') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.setAttribute('data-theme', 'light');
                }
            }
        }
        const savedTheme = localStorage.getItem('pbs_theme') || 'auto';
        document.getElementById('themeSelector').value = savedTheme;
        setTheme(savedTheme);

        const vmInput = document.getElementById("vmInput");
        const vmList = document.getElementById("vmList");
        const snapshotSelect = document.getElementById("snapshotSelect");
        const logWindow = document.getElementById("logWindow");
        const globalError = document.getElementById("globalError");
        let currentPartitionId = null;
        let currentPath = "";
        let logInterval = null;

        document.addEventListener('DOMContentLoaded', () => { checkStatus(); scanVMs(); });
        vmInput.addEventListener('focus', () => { if (vmList.innerHTML.trim() !== "") vmList.style.display = 'block'; });
        document.addEventListener('click', (e) => { if (!vmInput.contains(e.target) && !vmList.contains(e.target)) vmList.style.display = 'none'; });
        vmInput.addEventListener('input', () => {
            const filter = vmInput.value.toUpperCase();
            const items = vmList.getElementsByClassName("dropdown-item");
            for (let i = 0; i < items.length; i++) {
                const txt = items[i].textContent || items[i].innerText;
                items[i].style.display = (txt.toUpperCase().indexOf(filter) > -1) ? "block" : "none";
            }
            vmList.style.display = 'block';
        });

        async function scanVMs() {
            vmList.innerHTML = '<div class="p-2 text-muted">Scanning...</div>';
            try {
                const response = await fetch("/scan-vms", {method: "POST"});
                const data = await response.json();
                vmList.innerHTML = '';
                if (data.status === 'success') {
                    data.vms.forEach(vm => {
                        const div = document.createElement("div");
                        div.className = "dropdown-item";
                        div.textContent = vm;
                        div.onclick = () => { vmInput.value = vm; vmList.style.display = 'none'; loadSnapshots(vm); };
                        vmList.appendChild(div);
                    });
                }
            } catch (e) { log("Error scanning VMs"); }
        }

        async function loadSnapshots(val) {
            if(!val) return;
            snapshotSelect.innerHTML = '<option>Loading snapshots...</option>';
            snapshotSelect.disabled = true;
            let formData = new FormData();
            formData.append("vmid", val);
            try {
                const response = await fetch("/scan-snapshots", {method: "POST", body: formData});
                const data = await response.json();
                snapshotSelect.innerHTML = '';
                if (data.status === 'success') {
                    data.snapshots.forEach(snap => snapshotSelect.add(new Option(snap, snap)));
                    snapshotSelect.disabled = false;
                }
            } catch (e) { log("Error loading snapshots"); }
        }

        async function startBackup() {
            const snapshot = snapshotSelect.value;
            const remote = document.getElementById("remoteSelect").value;
            const targetFolder = document.getElementById("targetFolder").value;
            const sourcePaths = document.getElementById("sourcePaths").value;
            if (!snapshot || snapshotSelect.disabled) { log("Select snapshot first."); return; }
            
            document.getElementById("startBackupBtn").disabled = true;
            let formData = new FormData();
            formData.append("snapshot", snapshot);
            formData.append("remote", remote);
            formData.append("target_folder", targetFolder);
            formData.append("source_paths", sourcePaths);

            try {
                const res = await fetch("/start-stream", {method: "POST", body: formData});
                const data = await res.json();
                if(data.status === 'started') {
                    logWindow.innerHTML = "";
                    log("Job started. Waiting for logs...");
                    if (logInterval) clearInterval(logInterval);
                    logInterval = setInterval(fetchLogs, 2000);
                } else {
                    log("Failed: " + data.message);
                }
            } catch (e) { log("Connection failed."); }
            setTimeout(() => document.getElementById("startBackupBtn").disabled = false, 3000);
        }

        async function fetchLogs() {
            try {
                const res = await fetch("/stream-logs");
                const data = await res.json();
                if (data.logs) {
                    logWindow.innerText = data.logs;
                    logWindow.scrollTop = logWindow.scrollHeight;
                }
            } catch (e) {}
        }

        function log(msg) {
            logWindow.innerText += `\n[UI] ${msg}`;
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        let explorerModal;
        function openExplorer() {
            const snapshot = document.getElementById("snapshotSelect").value;
            if (!snapshot) return alert("Select snapshot first");
            currentPartitionId = null;
            currentPath = "";
            updateExplorerUI();
            
            if (!explorerModal) explorerModal = new bootstrap.Modal(document.getElementById('explorerModal'));
            explorerModal.show();
            loadPartitions(snapshot);
        }

        function updateExplorerUI() {
            document.getElementById("backToPartsBtn").style.display = (currentPartitionId !== null) ? "inline-block" : "none";
            document.getElementById("upDirBtn").style.display = (currentPath !== "") ? "inline-block" : "none";
            document.getElementById("currentPathLabel").innerText = currentPath ? currentPath : (currentPartitionId !== null ? "Root" : "Select Disk");
        }

        function goUpDir() {
            if (!currentPath) return;
            const parts = currentPath.split('/');
            parts.pop(); 
            explorePath(parts.join('/'));
        }

        async function loadPartitions(snapshot) {
            const list = document.getElementById("explorerList");
            list.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><p>Scanning partitions...</p></div>';
            let formData = new FormData(); formData.append("snapshot", snapshot);
            try {
                const res = await fetch("/explore", {method: "POST", body: formData});
                const data = await res.json();
                if (data.status === "success" && data.type === "partitions") renderPartitions(data.items);
                else list.innerHTML = `<div class="p-3 text-danger text-center">${data.message}</div>`;
            } catch (e) { list.innerHTML = "Error"; }
        }

        function renderPartitions(items) {
            const list = document.getElementById("explorerList"); list.innerHTML = "";
            items.forEach(p => {
                const div = document.createElement("div");
                div.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
                div.style.cursor = "pointer";
                div.onclick = () => selectPartition(p.id);
                div.innerHTML = `<div><i class="bi bi-device-hdd text-primary me-2"></i><strong>${p.name}</strong><span class="text-muted small ms-2">(${p.size})</span></div><i class="bi bi-chevron-right text-muted"></i>`;
                list.appendChild(div);
            });
        }

        function selectPartition(id) {
            currentPartitionId = id;
            currentPath = "";
            updateExplorerUI();
            explorePath("");
        }

        async function explorePath(path) {
            if (currentPartitionId === null) return;
            currentPath = path;
            updateExplorerUI();

            const snapshot = document.getElementById("snapshotSelect").value;
            const list = document.getElementById("explorerList");
            list.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm text-primary mb-2"></div><p>Listing...</p></div>';
            
            let formData = new FormData();
            formData.append("snapshot", snapshot);
            formData.append("path", path);
            formData.append("partition_id", currentPartitionId);
            
            try {
                const res = await fetch("/explore", {method: "POST", body: formData});
                const data = await res.json();
                if (data.status === "success" && data.type === "files") renderFiles(data.items);
                else list.innerHTML = `<div class="p-3 text-danger">${data.message}</div>`;
            } catch (e) { list.innerHTML = "Error"; }
        }

        function renderFiles(items) {
            const list = document.getElementById("explorerList"); list.innerHTML = "";
            if(items.length===0) list.innerHTML = '<div class="p-3 text-muted text-center">Empty Directory</div>';
            items.forEach(item => {
                const isDir = item.type === 'dir';
                const icon = isDir ? 'bi-folder-fill text-warning' : 'bi-file-earmark-text text-secondary';
                const div = document.createElement("div");
                div.className = "list-group-item d-flex justify-content-between align-items-center";
                
                const leftContent = document.createElement("div");
                leftContent.className = "d-flex align-items-center text-truncate";
                leftContent.style.maxWidth = "70%";
                leftContent.innerHTML = `<i class="bi ${icon} me-2"></i> <span title="${item.name}">${item.name}</span>`;
                
                if (isDir) {
                    leftContent.style.cursor = "pointer";
                    leftContent.onclick = () => explorePath(item.path);
                }
                div.appendChild(leftContent);

                const btnGroup = document.createElement("div");
                if(isDir) {
                    const btnOpen = document.createElement("button");
                    btnOpen.className = "btn btn-sm btn-outline-primary py-0 px-2 me-1";
                    btnOpen.innerHTML = '<i class="bi bi-arrow-return-right"></i> Open';
                    btnOpen.onclick = (e) => { e.stopPropagation(); explorePath(item.path); };
                    btnGroup.appendChild(btnOpen);
                }
                const btnAdd = document.createElement("button");
                btnAdd.className = "btn btn-sm btn-outline-success py-0 px-2";
                btnAdd.innerHTML = '<i class="bi bi-plus-lg"></i> Add';
                btnAdd.onclick = (e) => { e.stopPropagation(); addPathToInput(item.path); };
                btnGroup.appendChild(btnAdd);

                div.appendChild(btnGroup);
                list.appendChild(div);
            });
        }

        function addPathToInput(path) {
            const input = document.getElementById("sourcePaths");
            let current = input.value.split(',').map(s => s.trim()).filter(s => s);
            if (!current.includes(path)) { current.push(path); input.value = current.join(', '); }
        }

        async function checkStatus() {
            try {
                const res = await fetch("/check-status");
                const status = await res.json();
                updateBadge('pbsStatus', status.pbs);
                updateBadge('rcloneStatus', status.rclone);
                if (!status.pbs.status || !status.rclone.status) {
                    document.getElementById('globalError').style.display = 'block';
                    document.getElementById('globalErrorText').innerText = "Check Config";
                }
            } catch(e) {}
        }
        function updateBadge(id, s) { document.getElementById(id).className = 'status-badge ' + (s.status ? 'status-online' : 'status-offline'); }
    </script>
</body>
</html>