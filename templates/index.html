<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PbSync - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --pbs-bg-dark: #121212;
            --pbs-panel-bg: #212121;
            --pbs-header-bg: #282929;
            --pbs-border: #383838;
            --pbs-text-main: #e0e0e0;
            --pbs-text-muted: #abb2bf;
            --pbs-orange: #E57000;
            --pbs-blue: #3892d6;
            --pbs-green: #21ba45;
            --pbs-input-bg: #121212;
        }

        body {
            background-color: var(--pbs-bg-dark);
            color: var(--pbs-text-main);
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & STATUS BAR --- */
        .pbs-header {
            background-color: var(--pbs-header-bg);
            border-bottom: 2px solid var(--pbs-orange);
            padding: 0 20px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo-text { font-weight: 700; font-size: 18px; color: #fff; letter-spacing: 0.5px; }
        .logo-text span { color: var(--pbs-orange); }

        .status-bar {
            background-color: #2c2c2c;
            border-bottom: 1px solid var(--pbs-border);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--pbs-text-muted);
        }
        .status-tag {
            background-color: #333;
            padding: 2px 8px;
            border-radius: 2px;
            color: #fff;
            margin-left: 10px;
            font-family: 'Roboto Mono', monospace;
            border: 1px solid #444;
        }

        /* --- MAIN LAYOUT --- */
        .main-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* --- PANELS --- */
        .pbs-panel {
            background-color: var(--pbs-panel-bg);
            border: 1px solid var(--pbs-border);
            width: 100%;
            max-width: 800px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .pbs-panel-header {
            background-color: #2c2c2c;
            padding: 10px 15px;
            border-bottom: 1px solid var(--pbs-border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .pbs-panel-header i { color: var(--pbs-blue); }

        .pbs-panel-body { padding: 20px; }

        /* --- FORMS --- */
        .form-label {
            color: var(--pbs-text-main);
            font-weight: 600;
            font-size: 13px;
        }
        .form-control, .form-select {
            background-color: var(--pbs-input-bg);
            border: 1px solid var(--pbs-border);
            color: white;
            border-radius: 2px; /* Sharp corners */
            font-size: 13px;
            padding: 8px;
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--pbs-input-bg);
            border-color: var(--pbs-blue);
            color: white;
            box-shadow: none;
        }
        .form-control:disabled, .form-select:disabled {
            background-color: #1a1a1a;
            color: #666;
        }

        /* --- BUTTONS --- */
        .btn-pbs {
            background-color: var(--pbs-blue);
            color: white;
            border: none;
            border-radius: 2px;
            font-weight: 600;
            padding: 8px 16px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }
        .btn-pbs:hover { background-color: #2c7bb6; color: white; }
        .btn-pbs:disabled { background-color: #444; color: #888; }
        
        .btn-secondary-pbs {
            background-color: #444;
            color: #eee;
            border: 1px solid #555;
            border-radius: 2px;
            padding: 8px 12px;
        }
        .btn-secondary-pbs:hover { background-color: #555; color: white; }

        /* --- LOG WINDOW --- */
        .log-window {
            background-color: #000;
            border: 1px solid var(--pbs-border);
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            padding: 10px;
            color: #ccc;
            height: 150px;
            overflow-y: auto;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
        .log-line { margin-bottom: 2px; }
        .log-success { color: var(--pbs-green); }
        .log-error { color: #ff6b6b; }
        .log-info { color: var(--pbs-blue); }

    </style>
</head>
<body>

    <div class="pbs-header">
        <div class="logo-text"><i class="bi bi-hdd-network me-2"></i><span>Pb</span>Sync</div>
        <div class="d-flex align-items-center gap-3">
            <a href="/setup" class="text-decoration-none text-muted small hover-white">
                <i class="bi bi-gear-fill me-1"></i> Configuration
            </a>
            <div class="text-muted small"><i class="bi bi-person-circle me-1"></i> root@pbsync</div>
        </div>
    </div>

    <div class="status-bar">
        <i class="bi bi-diagram-3-fill me-2"></i>
        <span>Datacenter</span>
        <i class="bi bi-chevron-right mx-2 text-muted"></i>
        <span>PbSync Node</span>
        <i class="bi bi-chevron-right mx-2 text-muted"></i>
        <span>Stream Task</span>
        
        <div class="ms-auto d-flex align-items-center">
            <span>Connected Repository:</span>
            <span class="status-tag"><i class="bi bi-database-fill me-1 text-warning"></i> {{ config.pbs_repository_path }}</span>
        </div>
    </div>

    <div class="main-container">
        
        <div class="pbs-panel">
            <div class="pbs-panel-header">
                <i class="bi bi-cloud-upload-fill"></i> Stream Backup to Cloud
            </div>
            
            <div class="pbs-panel-body">
                <form id="backupForm" onsubmit="return false;">
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h6 class="text-muted text-uppercase small fw-bold mb-3 border-bottom border-secondary pb-2">Source Selection</h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Virtual Machine ID</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-light border-end-0"><i class="bi bi-pc-display"></i></span>
                                <input type="text" id="vmid" class="form-control border-start-0 ps-0" placeholder="e.g. 101">
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <label class="form-label">&nbsp;</label> <div class="d-block">
                                <button type="button" id="getSnapshotsBtn" onclick="getSnapshots()" class="btn-secondary-pbs w-100 text-start">
                                    <i class="bi bi-search me-2"></i> Scan for Snapshots
                                    <span id="scanSpinner" class="spinner-border spinner-border-sm float-end mt-1 d-none"></span>
                                </button>
                            </div>
                        </div>

                        <div class="col-12 mt-3">
                            <label class="form-label">Backup Snapshot</label>
                            <select id="snapshotSelect" class="form-select" disabled>
                                <option selected disabled>Please scan a VM ID first...</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h6 class="text-muted text-uppercase small fw-bold mb-3 border-bottom border-secondary pb-2 mt-2">Target Configuration</h6>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Target Remote (Rclone)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-light border-end-0"><i class="bi bi-cloud-check-fill"></i></span>
                                <select id="remoteSelect" class="form-select border-start-0 ps-0">
                                    {% if remotes and not "HATA" in remotes[0] %}
                                        {% for remote in remotes %}
                                        <option value="{{ remote }}">{{ remote }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled selected>{{ remotes[0] or "No rclone remotes found." }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end pt-3 border-top border-secondary">
                        <button type="button" id="startBackupBtn" onclick="startBackup()" class="btn-pbs">
                            <i class="bi bi-play-circle-fill"></i> Start Stream Task
                        </button>
                    </div>

                </form>

                <div id="logWindow" class="log-window">
                    <div class="log-line text-muted"># Waiting for user input...</div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // --- Elements ---
        const vmidInput = document.getElementById("vmid");
        const getSnapshotsBtn = document.getElementById("getSnapshotsBtn");
        const scanSpinner = document.getElementById("scanSpinner");
        const snapshotSelect = document.getElementById("snapshotSelect");
        const startBackupBtn = document.getElementById("startBackupBtn");
        const logWindow = document.getElementById("logWindow");

        // --- Logger Function (Mimics Terminal) ---
        function log(msg, type = 'info') {
            logWindow.style.display = 'block';
            const line = document.createElement('div');
            line.className = 'log-line';
            
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let icon = '';
            let colorClass = '';

            if (type === 'error') { icon = '[ERROR]'; colorClass = 'log-error'; }
            else if (type === 'success') { icon = '[OK]'; colorClass = 'log-success'; }
            else { icon = '[INFO]'; colorClass = 'log-info'; }

            line.innerHTML = `<span class="text-muted">${time}</span> <span class="${colorClass}">${icon}</span> ${msg}`;
            logWindow.appendChild(line);
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        // --- Logic ---
        async function getSnapshots() {
            let vmid = vmidInput.value;
            if (!vmid) {
                log("Validation Error: Please enter a Virtual Machine ID.", "error");
                vmidInput.focus();
                return;
            }

            log(`Connecting to PBS... Scanning snapshots for VM ${vmid}...`);
            getSnapshotsBtn.disabled = true;
            scanSpinner.classList.remove("d-none");

            let formData = new FormData();
            formData.append("vmid", vmid);
            
            try {
                const response = await fetch("/scan-snapshots", {method: "POST", body: formData});
                const data = await response.json();
                
                snapshotSelect.innerHTML = "";
                
                if (data.status === "success" && data.snapshots.length > 0) {
                    data.snapshots.forEach(snap => {
                        let opt = new Option(snap, snap);
                        snapshotSelect.appendChild(opt);
                    });
                    snapshotSelect.disabled = false;
                    log(`Found ${data.snapshots.length} snapshots for VM ${vmid}.`, "success");
                } else {
                    snapshotSelect.disabled = true;
                    snapshotSelect.innerHTML = '<option selected disabled>No snapshots found.</option>';
                    log(data.message || "No snapshots found.", "error");
                }
            } catch (error) {
                log(`Connection Error: ${error}`, "error");
            } finally {
                getSnapshotsBtn.disabled = false;
                scanSpinner.classList.add("d-none");
            }
        }

        async function startBackup() {
            let snapshot = snapshotSelect.value;
            let remote = document.getElementById("remoteSelect").value;

            if (!snapshot || snapshotSelect.disabled) {
                log("Validation Error: No snapshot selected.", "error");
                return;
            }

            log("Initializing Stream Task...", "info");
            log(`Source: ${snapshot}`);
            log(`Target: ${remote}`);

            startBackupBtn.disabled = true;
            startBackupBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
            
            let formData = new FormData();
            formData.append("snapshot", snapshot);
            formData.append("remote", remote);

            try {
                const response = await fetch("/start-stream", {method: "POST", body: formData});
                const data = await response.json();
                
                if (data.status === "started") {
                    log("TASK STARTED SUCCESSFULLY", "success");
                    log(data.message);
                    log("Check server logs for detailed progress.", "info");
                } else {
                    log(`Task Failed: ${data.message}`, "error");
                }
            } catch (error) {
                log(`Network Error: ${error}`, "error");
            } finally {
                // Reset button after 3 seconds
                setTimeout(() => {
                    startBackupBtn.disabled = false;
                    startBackupBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> Start Stream Task';
                }, 3000);
            }
        }

        // Enter key trigger
        vmidInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                getSnapshotsBtn.click();
            }
        });
    </script>
</body>
</html>